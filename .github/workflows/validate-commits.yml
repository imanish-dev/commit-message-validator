name: Enforce Conventional Commit Messages

on:
  push:
    branches:
      - main

jobs:
  check-commit-messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check commit messages
        run: |
          echo "üîç Checking commit messages for Conventional Commits format..."

          # Determine commit range or single commit
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First commit or empty before, just check the latest commit
            commits="${{ github.sha }}"
          else
            # Normal case: check all commits in the range
            commits=$(git log --format="%H" ${{ github.event.before }}..${{ github.sha }})
          fi

          failed=0

          for sha in $commits; do
            message=$(git log -1 --pretty=%B $sha | head -n1)

            if [[ ! "$message" =~ ^(feat|fix|chore|docs|style|refactor|test|perf)(\(.+\))?:\ .+ ]]; then
              echo "‚ùå Commit $sha message is invalid: \"$message\""
              failed=1
            else
              echo "‚úÖ Commit $sha message is valid: \"$message\""
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "::error::One or more commits have invalid messages."
            exit 1
          fi

          echo "‚úÖ All commit messages are valid."

