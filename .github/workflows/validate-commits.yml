name: Enforce Conventional Commit Messages

on:
  push:
    branches:
      - main

jobs:
  check-commit-messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check commit messages
        run: |
          echo "üîç Checking commit messages for Conventional Commits format..."

          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          # Check if 'before' exists in history
          if [ -z "$before" ] || [ "$before" = "0000000000000000000000000000000000000000" ] || ! git cat-file -e "$before^{commit}" 2>/dev/null; then
            # 'before' does not exist, just check the latest commit
            commits="$after"
          else
            # Normal case: check all commits in the range
            commits=$(git log --format="%H" $before..$after)
          fi

          failed=0

          for sha in $commits; do
            message=$(git log -1 --pretty=%B $sha | head -n1)

            if [[ ! "$message" =~ ^(feat|fix|chore|docs|style|refactor|test|perf)(\(.+\))?:\ .+ ]]; then
              echo "‚ùå Commit $sha message is invalid: \"$message\""
              failed=1
            else
              echo "‚úÖ Commit $sha message is valid: \"$message\""
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "::error::One or more commits have invalid messages."
            exit 1
          fi

          echo "‚úÖ All commit messages are valid."

